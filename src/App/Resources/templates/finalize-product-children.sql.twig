SELECT
{% for attribute in attributes %}
    {% for field in attribute.fields %}
    {{ as_attribute_table(attribute) }}.`{{ as_field_column(field) }}`,
    {% endfor %}
{% endfor %}
    hierarchy.child AS code,
    hierarchy.parent AS parent,
    hierarchy.color AS color,
    hierarchy.capacity AS capacity,
    'default_variant' AS family_variant
FROM (
    SELECT hierarchy.parent, hierarchy.child, hierarchy.color, hierarchy.capacity, MIN(product.entity_id) AS entity_id
    FROM tmp_hierarchy AS hierarchy
    INNER JOIN tmp_sku AS product
        ON hierarchy.iv=product.sku
    GROUP BY hierarchy.parent, hierarchy.child, hierarchy.color, hierarchy.capacity
) AS hierarchy
{% for attribute in attributes %}
INNER JOIN {{ as_attribute_table(attribute) }}
    ON {{ as_attribute_table(attribute) }}.entity_id=product.entity_id
{% endfor %}
