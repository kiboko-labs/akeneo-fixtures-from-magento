CREATE /*TEMPORARY*/ TABLE tmp_hierarchy (
    parent VARCHAR(128) NOT NULL,
    child VARCHAR(128) NOT NULL,
    variant VARCHAR(128) NOT NULL,
    PRIMARY KEY (parent, child, variant),
    INDEX (parent),
    INDEX (child),
    INDEX (variant)
) CHARACTER SET=utf8mb4 COLLATE=utf8mb4_unicode_ci

{% set variantRequests = [] %}
{% for variant in variants %}
    {% if variant.isTwoLevels == true %}
    {% set request %}
SELECT
    product.sku AS parent,
    {{ as_product_hierarchy_sku_field('product.sku', variant) }} AS child,
    child.sku AS variant
FROM catalog_product_entity AS product
INNER JOIN catalog_product_super_link AS link
    ON link.parent_id=product.entity_id
INNER JOIN catalog_product_entity AS child
    ON child.entity_id=link.product_id
{% for attribute in variant.axis(1).attributes %}
INNER JOIN {{ as_attribute_table(attribute.attribute) }} AS {{ as_attribute_alias(attribute.attribute) }}
    ON {{ as_attribute_alias(attribute.attribute) }}.entity_id = child.entity_id
{% endfor %}
WHERE product.sku IS NOT NULL
  AND child.sku IS NOT NULL
  AND product.type_id IN ('configurable')
{% for attribute in variant.axis(1).attributes -%}
    {% for field in attribute.fields() %}
  AND {{ as_attribute_alias(attribute.attribute) }}.`{{ as_field_column(field) }}` IS NOT NULL
    {% endfor -%}
{% endfor -%}
    {% endset %}

    {% set variantRequests = variantRequests|merge([request]) %}

    {% endif %}
{% endfor %}

{% if variantRequests|length > 0 %}
SELECT *
FROM (
{{ variantRequests|join('UNION\n') }}
) AS subrequests;
{% endif %}