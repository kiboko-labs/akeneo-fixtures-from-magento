
CREATE TEMPORARY TABLE {{ as_attribute_table(attribute) }} (
    sku VARCHAR(128) NOT NULL,
    entity_id INTEGER NOT NULL,
    type_id VARCHAR(32) NOT NULL,
    code VARCHAR(255) NULL,
    PRIMARY KEY (sku),
    UNIQUE INDEX (entity_id)
)
SELECT
    product.*,
    {{ as_default_alias() }}.code
FROM tmp_sku AS product
INNER JOIN eav_attribute AS attribute
    ON attribute.attribute_code='{{ attribute.codeInSource }}' AND attribute.entity_type_id=4
INNER JOIN catalog_product_entity_int AS {{ as_default_alias() }}
    ON {{ as_default_alias() }}.entity_id=product.entity_id
    AND {{ as_default_alias() }}.attribute_id=attribute.attribute_id
    AND {{ as_default_alias() }}.store_id=0
LEFT JOIN (
    SELECT *
    FROM tmp_options
    WHERE attribute LIKE '{{ attribute.codeInSource }}'
) AS {{ as_default_alias() }}_option
    ON attr_default.value=option_default.option_id;
