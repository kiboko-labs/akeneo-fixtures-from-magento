#!/usr/bin/env php
<?php

try {
    $pdo = new \PDO($argv[1], $argv[2], $argv[3], [
        \PDO::ATTR_ERRMODE => \PDO::ERRMODE_EXCEPTION,
        PDO::MYSQL_ATTR_INIT_COMMAND => 'SET NAMES utf8',
    ]);

    for ($i = 4; $i < $argc; ++$i) {
        $requests = array_filter(explode(';', file_get_contents($argv[$i])), function($request) {
            return !empty(trim($request));
        });

        foreach ($requests as $request) {
            $pdo->exec($request);
        }
    }

    $statement = $pdo->prepare($request = file_get_contents('php://stdin'));
    $statement->setFetchMode(PDO::FETCH_ASSOC);
    $statement->execute();
} catch (\PDOException $e) {
    file_put_contents('php://stderr', var_export($request, true) . PHP_EOL);
    file_put_contents('php://stderr', var_export($e->errorInfo, true) . PHP_EOL);
    file_put_contents('php://stderr', $e);
    return -1;
} catch (\Error $e) {
    file_put_contents('php://stderr', $e);
    return -1;
}

$file = new SplFileObject('php://stdout', 'w');
$file->setCsvControl(';');

$i = 0;
foreach ($statement as $index => $row) {
    if ($index === 0) {
        $file->fputcsv(array_keys($row));
    }

    $file->fputcsv($row);
    (++$i % 100) || ob_flush();
}
